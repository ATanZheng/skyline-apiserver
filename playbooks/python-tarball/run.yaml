- hosts: all
  tasks:
    - name: Install tox, nvm, nodejs and yarn
      shell:
        executable: /bin/bash
        cmd: |
          # nvm
          wget -P $HOME --tries=10 --retry-connrefused --waitretry=60 --no-dns-cache --no-cache  https://raw.githubusercontent.com/nvm-sh/nvm/master/install.sh
          bash $HOME/install.sh
          . $HOME/.nvm/nvm.sh
          # nodejs
          NODE_VERSION=erbium
          nvm install --lts=$NODE_VERSION
          nvm alias default lts/$NODE_VERSION
          nvm use default
          # yarn
          npm install -g yarn
          # tox
          pip3 install tox
    - name: Build tarball and wheel
      shell:
        executable: /bin/bash
        cmd: |
          git submodule update --init
          . $HOME/.nvm/nvm.sh
          $HOME/.local/bin/tox -e package
      args:
        chdir: "src/{{ zuul.project.canonical_name }}"
    - name: Remove the invalid tar.gz packages
      shell:
        executable: /bin/bash
        cmd: |
          rm -rf *.tar.gz
      args:
        chdir: "src/{{ zuul.project.canonical_name }}/dist"
    - name: Move all tar.gz packages into dist
      shell: "mv libs/{{ item }}/dist/*.tar.gz dist/"
      args:
        chdir: "src/{{ zuul.project.canonical_name }}"
      with_items:
        - "skyline-apiserver"
        - "skyline-config"
        - "skyline-console"
        - "skyline-log"
        - "skyline-nginx"
        - "skyline-policy-manager"
    - name: All tar.gz into skyline.tar.gz
      shell:
        executable: /bin/bash
        cmd: |
          mkdir -p packages
          mv *.tar.gz packages
          mv packages skyline-apiserver
          tar -czf skyline-apiserver.tar.gz skyline-apiserver
          rm -rf skyline-apiserver
      args:
        chdir: "src/{{ zuul.project.canonical_name }}/dist"
